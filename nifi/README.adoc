= Apache Nifi on OpenShift 4.7

== Introduction

This document explains how to deploy Nifi on OpenShift.

== Prerequisites

* Nifi Kubernetes Operator
** https://github.com/hyperkineticnerd/nifikop/tree/snelson

== Installation

Clone Nifi operator:
[source,bash]
-----
git clone -b snelson https://github.com/hyperkineticnerd/nifikop
cd nifikop
-----

Edit/Change Makefile for building operator. The value should be the internal registry for
[source,Makefile]
-----
DOCKER_REGISTRY_BASE 	?= quay.io/hyperkineticnerd
-----

Build and push nifikop operator:
[source,bash]
-----
make docker-build docker-push
-----

Create RBAC for deployment:

.RBAC.yaml
[source,yaml]
-----
# permissions to do leader election.
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: leader-election-role
rules:
- apiGroups:
  - ""
  - coordination.k8s.io
  resources:
  - configmaps
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: leader-election-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: leader-election-role
subjects:
- kind: ServiceAccount
  name: default
  namespace: nifi
- kind: ServiceAccount
  name: nifikop
  namespace: nifi

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: nifikop-manager-role
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - create
  - delete
  - get
  - list
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - cert-manager.io
  resources:
  - certificates
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - cert-manager.io
  resources:
  - clusterissuers
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - cert-manager.io
  resources:
  - issuers
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nificlusters
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nificlusters/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nificlusters/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifidataflows
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nifidataflows/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifidataflows/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiparametercontexts
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiparametercontexts/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiparametercontexts/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiregistryclients
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiregistryclients/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiregistryclients/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiusergroups
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiusergroups/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiusergroups/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiusers
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiusers/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.orange.com
  resources:
  - nifiusers/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nifikop-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nifikop-manager-role
subjects:
- kind: ServiceAccount
  name: default
  namespace: nifi
- kind: ServiceAccount
  name: nifikop
  namespace: nifi
-----

Edit helm chart values.yaml to deploy nifikop:
.helm/nifikop/values.yaml
[source,yaml]
-----
image:
  repository: quay.io/hyperkineticnerd/nifikop
  tag: 0.5.3-snelson
-----

Deploy nifi via helm Chart:
[source,bash]
-----
helm install nifikop ./helm/nifikop --namespace "nifi"
-----

Create Nifi Cluster via CRD (Apply via `oc apply -f <file>`):
[source,yaml]
-----
apiVersion: nifi.orange.com/v1alpha1
kind: NifiCluster
metadata:
  name: simple-nifi
spec:
  service:
    headlessEnabled: true
  zkAddress: "zookeeper.zookeeper.svc.cluster.local:2181"
  zkPath: "/simplenifi"
  clusterImage: "apache/nifi:1.12.1"
  oneNifiNodePerNode: false
  nodeConfigGroups:
    default_group:
      isNode: true
      storageConfigs:
        - mountPath: "/opt/nifi/nifi-current/logs"
          name: logs
          pvcSpec:
            accessModes:
              - ReadWriteOnce
            storageClassName: "ovirt-csi-sc"
            resources:
              requests:
                storage: 10Gi
      serviceAccountName: "default"
      resourcesRequirements:
        limits:
          cpu: "0.5"
          memory: 2Gi
        requests:
          cpu: "0.5"
          memory: 2Gi
  nodes:
    - id: 1
      nodeConfigGroup: "default_group"
    - id: 2
      nodeConfigGroup: "default_group"
  propagateLabels: true
  nifiClusterTaskSpec:
    retryDurationMinutes: 10
  listenersConfig:
    internalListeners:
      - type: "http"
        name: "http"
        containerPort: 8080
      - type: "cluster"
        name: "cluster"
        containerPort: 6007
      - type: "s2s"
        name: "s2s"
        containerPort: 10000
  externalServices:
    - name: "clusterip"
      spec:
        type: ClusterIP
        portConfigs:
          - port: 8080
            internalListenerName: "http"
      serviceAnnotations:
        toto: tata
    - name: "loadbalancer"
      spec:
        type: LoadBalancer
        portConfigs:
          - port: 8080
            internalListenerName: "http"
      serviceAnnotations:
        toto: tata
    - name: "nodepart"
      spec:
        type: NodePort
        portConfigs:
          - port: 8080
            internalListenerName: "http"
      serviceAnnotations:
        toto: tata
-----
 